# Unix-shell
Простой интерактивный unix shell на Python.

**Поддержка команд:**
* `cd <path>`
* `ls [-l] <path...>`
* `mv [-r] <source...> <dest>`
* `cp [-r] <source...> <dest>`
* `rm [-r] [-y] <path...>`
* `cat <path...>`
* `grep [-r] [-i] <pattern> <path>`
* `zip [-r] <source...> <archive.zip>`
* `unzip <archive.zip> <dest>`
* `tar [-r] <source...> <archive.tar.gz>`
* `untar <archive.tar.gz> <folder>`
* `mkdir [-p] <path...>`
* `history <n>`
* `undo`
* `pwd`
* `whoami`
* `exit`

**Ключевые особенности:**
*   Удалённые файлы временно хранятся в `.trash` для возможности восстановления.
*   История команд сохраняется в файле `.history`.
*   Ведутся логи операций в `shell.log`.
*   Все команды поддерживают флаг `-h` для вывода детального описания.

## Оглавление
- [Использование](#использование)
- [Архитектура Проекта](#архитектура-проекта)
    - [Основные компоненты](#основные-компоненты)
    - [Поток выполнения команд](#поток-выполнения-команд)
    - [Обработка ошибок](#обработка-ошибок)
    - [Отмена действий и история](#отмена-действий-и-история)
- [Технологии](#технологии)
- [Расширяемость](#расширяемость)

## Использование

### Установка
Проект использует `uv` для управления виртуальным окружением и `Makefile` для автоматизации команд.

**Требования:**
*   Python 3.13+
*   `make`
*   `uv` (устанавливается командой `pip install uv`)

**Установка зависимостей**
```bash
make install
```

### Запуск приложения

Приложение можно запустить как с помощью удобных команд `make`, так и напрямую через `uv`.

Через `Makefile`:
```bash
make run
```
Напрямую через `uv`:
```bash
uv run main.py
```

Для выхода из программы введите `exit`, `quit` или `Ctrl-D`.

## Архитектура Проекта

Проект построен на принципах чистой архитектуры, что обеспечивает разделение ответственностей и слабую связность между компонентами.

*   **`domain/` — Ядро бизнес-логики.**
    *   Определяет основные сущности и протоколы: `Command`, `UndoCommand`, `CommandContext`, `UndoRecord` и типы ошибок.
*   **`usecase/` — Слой бизнес-сценариев.**
    *   Содержит класс `Shell`, который координирует выполнение команд, управление историей и операциями отмены.
    *   Определяет интерфейсы (`HistoryRepository`, `UndoRepository`) для внешних зависимостей.
*   **`repository/` — Реализации интерфейсов.**
    *   Содержит конкретные реализации репозиториев для работы с историей команд и стеком отмены действий.
*   **`adapter/` — Взаимодействие с внешним миром.**
    *   Реализует интерфейс командной строки (`cli.py`) и содержит реализации всех доступных команд.
*   **`main.py` — Точка входа и сборка зависимостей.**
    *   Инициализирует все компоненты и запускает главный цикл приложения.

### Основные компоненты

*   `Shell`: Центральный класс, управляющий жизненным циклом приложения. Он принимает ввод пользователя, находит и выполняет соответствующую команду, а также управляет историей и операциями отмены.
*   `Command`: Протокол, который должна реализовывать каждая команда. Он определяет базовый интерфейс с методами `execute` и свойствами `name` и `description`.
*   `UndoCommand`: Расширение протокола `Command` для команд, поддерживающих отмену действий. Добавляет метод `undo`, который возвращает последовательность записей `UndoRecord`.
*   `CommandContext`: Контекст выполнения, содержащий информацию о текущем пользователе, домашнем каталоге и рабочей директории (`pwd`).
*   `HistoryRepository` и `UndoRepository`: Протоколы, определяющие интерфейсы для хранения и извлечения истории команд и записей для отмены действий.

### Поток выполнения команд
1.  Пользователь вводит команду в `cli`.
2.  `Shell` получает имя команды, аргументы и флаги.
3.  Осуществляется поиск команды в словаре `_commands`.
4.  Если команда найдена, вызывается её метод `execute`.
5.  Команда выполняет свою логику.
6.  Если команда реализует `UndoCommand`, её данные для отмены сохраняются через `UndoRepository`.
7.  Результат выполнения возвращается в `cli` для вывода.
8.  Команда и её аргументы добавляются в историю через `HistoryRepository`.

### Обработка ошибок

В приложении используется иерархия доменных ошибок для обработки исключительных ситуаций:
*   `DomainError`: Базовый класс для всех ошибок бизнес-логики.
*   `CommandNotFoundError`: Возникает, если введённая команда не найдена.
*   `ValidationError`: Возникает при некорректных аргументах или флагах команды.

Эти ошибки перехватываются на уровне адаптеров (`cli.py`).

### Отмена действий и история

*   **Undo**: Команды, которые изменяют состояние файловой системы (`mv`, `cp`, `rm`, `undo`), реализуют интерфейс `UndoCommand`. Они генерируют пачку `UndoRecord` — структуру данных, описывающую, как отменить операцию. Эти записи сохраняются в `UndoRepository`. Команда `undo` извлекает последнюю запись и выполняет обратное действие.
*   **History**: Каждая выполненная команда сохраняется с помощью `HistoryRepository`. Команда `history` позволяет просмотреть список последних выполненных команд.

## Технологии
*   **Инструменты:**
    *   **`uv`**: Для управления пакетами и виртуальным окружением.
    *   **`pytest`**: Для юнит-тестов.
    *   **`ruff`**: Для линтинга и форматирования кода.
    *   **`mypy`**: Для статической проверки типов.
    *   **`make pre-commit`**: Вызывает ruff, mypy, pytest перед каждым коммитом (добавлен в git hook).

## Расширяемость

### Добавление новой команды
Для добавления новой команды необходимо:
1.  Создать новый класс, реализующий протокол `Command`.
2.  Определить уникальное `name` и информативное `description`.
3.  Реализовать логику выполнения в методе `execute`.
4.  Если команда должна поддерживать отмену, реализовать также протокол `UndoCommand` и его метод `undo`.
5.  Добавить экземпляр нового класса в словарь команд при инициализации `Shell` в `main.py`.
